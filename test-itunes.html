<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>iTunes Preview Test</title>
  <style>
    body { font-family: system-ui; padding: 20px; max-width: 500px; margin: 0 auto; }
    button { padding: 15px 30px; font-size: 18px; margin: 10px 0; cursor: pointer; }
    button:disabled { opacity: 0.5; }
    #status { padding: 10px; background: #f0f0f0; margin: 10px 0; border-radius: 8px; white-space: pre-wrap; }
    #artwork { width: 100px; height: 100px; background-size: cover; background-color: #ddd; border-radius: 8px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>iTunes Preview Test</h1>
  <p>Testing: Beyoncé - Halo</p>
  <div id="artwork"></div>
  <div id="status">Loading preview URL...</div>
  <button id="playBtn" disabled>Loading...</button>
  
  <script>
    const status = document.getElementById('status');
    const artwork = document.getElementById('artwork');
    const playBtn = document.getElementById('playBtn');
    
    let audio = null;
    let playing = false;
    
    // Preload on page load
    async function preload() {
      const artist = "Beyoncé";
      const title = "Halo";
      
      try {
        const term = encodeURIComponent(`${artist} ${title}`);
        const url = `https://itunes.apple.com/search?term=${term}&entity=song&limit=5`;
        
        status.textContent = "Fetching preview URL...";
        const res = await fetch(url);
        
        if (!res.ok) {
          status.textContent = "Fetch failed: " + res.status;
          return;
        }
        
        const data = await res.json();
        
        if (data.results && data.results.length > 0) {
          const track = data.results[0];
          
          if (track.artworkUrl100) {
            artwork.style.backgroundImage = `url('${track.artworkUrl100}')`;
          }
          
          if (track.previewUrl) {
            status.textContent = `Found: ${track.trackName}\nby ${track.artistName}\n\nCreating audio element...`;
            
            // Create and preload audio
            audio = new Audio();
            audio.setAttribute('playsinline', '');
            audio.setAttribute('webkit-playsinline', '');
            audio.preload = 'auto';
            audio.src = track.previewUrl;
            
            audio.addEventListener('canplaythrough', () => {
              status.textContent += "\n✓ Audio ready!";
            });
            
            audio.addEventListener('playing', () => {
              status.textContent = "Playing!";
              playBtn.textContent = "⏸ Pause";
              playing = true;
            });
            
            audio.addEventListener('pause', () => {
              playBtn.textContent = "▶ Play";
              playing = false;
            });
            
            audio.addEventListener('ended', () => {
              status.textContent = "Playback ended";
              playBtn.textContent = "▶ Play Again";
              playing = false;
            });
            
            audio.addEventListener('error', (e) => {
              status.textContent = "Audio error: " + (audio.error?.message || 'unknown');
            });
            
            // Enable button
            playBtn.textContent = "▶ Play Preview";
            playBtn.disabled = false;
            status.textContent += "\n\nReady! Tap play.";
          } else {
            status.textContent = "No preview URL in response";
          }
        } else {
          status.textContent = "No results found";
        }
      } catch (e) {
        status.textContent = "Error: " + e.message;
      }
    }
    
    // Simple click handler - NO async/await
    playBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (!audio) {
        status.textContent = "No audio loaded";
        return;
      }
      
      if (playing) {
        audio.pause();
        status.textContent = "Paused";
      } else {
        status.textContent = "Starting playback...";
        // Use .then() instead of await
        audio.play().then(function() {
          status.textContent = "Playing!";
        }).catch(function(err) {
          status.textContent = "Play error: " + err.message + "\n\nThis usually means iOS blocked it. Try tapping again.";
        });
      }
    });
    
    // Start preloading
    preload();
  </script>
</body>
</html>
