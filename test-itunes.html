<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>iTunes Preview Test</title>
  <style>
    body { font-family: system-ui; padding: 20px; max-width: 500px; margin: 0 auto; }
    button { padding: 20px 40px; font-size: 20px; margin: 10px 0; cursor: pointer; display: block; width: 100%; }
    button:disabled { opacity: 0.5; }
    #status { padding: 15px; background: #f0f0f0; margin: 10px 0; border-radius: 8px; white-space: pre-wrap; font-size: 14px; }
    #artwork { width: 150px; height: 150px; background-size: cover; background-color: #ddd; border-radius: 12px; margin: 15px auto; }
    h1 { text-align: center; }
    p { text-align: center; color: #666; }
    .volume-note { background: #fff3cd; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 14px; }
  </style>
</head>
<body>
  <h1>üéµ Audio Test</h1>
  <p>Beyonc√© - Halo</p>
  <div class="volume-note">‚ö†Ô∏è Make sure your iPhone is not on Silent Mode (flip the switch on the side) and volume is up!</div>
  <div id="artwork"></div>
  <div id="status">Tap "Unlock Audio" first, then "Play"</div>
  <button id="unlockBtn">üîì Step 1: Unlock Audio</button>
  <button id="playBtn" disabled>‚ñ∂ Step 2: Play Preview</button>
  <button id="testTone">üîä Test: Play Beep Sound</button>
  
  <script>
    const status = document.getElementById('status');
    const artwork = document.getElementById('artwork');
    const playBtn = document.getElementById('playBtn');
    const unlockBtn = document.getElementById('unlockBtn');
    const testTone = document.getElementById('testTone');
    
    let audioContext = null;
    let audioBuffer = null;
    let sourceNode = null;
    let gainNode = null;
    let isPlaying = false;
    let isUnlocked = false;
    
    // Test tone button - plays a simple beep to verify audio works
    testTone.addEventListener('click', function() {
      if (!audioContext) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
      }
      
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      // Create oscillator for beep
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 440; // A4 note
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
      
      status.textContent = "üîä Beep! Did you hear it?\n\nIf not:\n- Check Silent Mode switch\n- Turn up volume\n- Check if connected to Bluetooth";
    });
    
    // Step 1: Unlock audio context with user gesture
    unlockBtn.addEventListener('click', function() {
      status.textContent = "Creating AudioContext...";
      
      try {
        // Create audio context
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
        
        // Create gain node for volume control
        gainNode = audioContext.createGain();
        gainNode.gain.value = 1.0; // Full volume
        gainNode.connect(audioContext.destination);
        
        status.textContent = "AudioContext state: " + audioContext.state;
        status.textContent += "\nSample rate: " + audioContext.sampleRate;
        
        // Resume if suspended
        if (audioContext.state === 'suspended') {
          audioContext.resume().then(function() {
            status.textContent = "AudioContext resumed!\nState: " + audioContext.state;
            isUnlocked = true;
            unlockBtn.textContent = "‚úì Audio Unlocked!";
            unlockBtn.disabled = true;
            
            // Now fetch the preview
            fetchPreview();
          });
        } else {
          isUnlocked = true;
          unlockBtn.textContent = "‚úì Audio Unlocked!";
          unlockBtn.disabled = true;
          status.textContent = "AudioContext ready!\nState: " + audioContext.state;
          
          // Now fetch the preview
          fetchPreview();
        }
      } catch(e) {
        status.textContent = "AudioContext error: " + e.message;
      }
    });
    
    async function fetchPreview() {
      status.textContent += "\n\nFetching iTunes preview...";
      
      try {
        const term = encodeURIComponent("Beyonc√© Halo");
        const url = `https://itunes.apple.com/search?term=${term}&entity=song&limit=5`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.results && data.results.length > 0) {
          const track = data.results[0];
          
          if (track.artworkUrl100) {
            artwork.style.backgroundImage = `url('${track.artworkUrl100.replace('100x100', '300x300')}')`;
          }
          
          if (track.previewUrl) {
            status.textContent += "\n‚úì Found preview URL";
            status.textContent += "\n\nDownloading audio data...";
            
            // Fetch audio as ArrayBuffer
            const audioRes = await fetch(track.previewUrl);
            const arrayBuffer = await audioRes.arrayBuffer();
            
            status.textContent += "\n‚úì Downloaded " + Math.round(arrayBuffer.byteLength / 1024) + "KB";
            status.textContent += "\n\nDecoding audio...";
            
            // Decode audio data
            audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            status.textContent += "\n‚úì Audio decoded!";
            status.textContent += "\nDuration: " + Math.round(audioBuffer.duration) + "s";
            status.textContent += "\nChannels: " + audioBuffer.numberOfChannels;
            status.textContent += "\nSample rate: " + audioBuffer.sampleRate;
            status.textContent += "\n\n‚úÖ Ready to play!";
            
            playBtn.disabled = false;
            playBtn.textContent = "‚ñ∂ Play Preview";
          }
        }
      } catch(e) {
        status.textContent += "\n\n‚ùå Error: " + e.message;
      }
    }
    
    // Step 2: Play using Web Audio API
    playBtn.addEventListener('click', function() {
      if (!audioContext || !audioBuffer) {
        status.textContent = "Audio not ready";
        return;
      }
      
      // Make sure context is running
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      if (isPlaying) {
        // Stop
        if (sourceNode) {
          try {
            sourceNode.stop();
          } catch(e) {}
          sourceNode = null;
        }
        isPlaying = false;
        playBtn.textContent = "‚ñ∂ Play Preview";
        status.textContent = "Stopped\n\nAudioContext state: " + audioContext.state;
        return;
      }
      
      // Create new source node (required each time)
      sourceNode = audioContext.createBufferSource();
      sourceNode.buffer = audioBuffer;
      
      // Connect through gain node
      sourceNode.connect(gainNode);
      
      sourceNode.onended = function() {
        isPlaying = false;
        playBtn.textContent = "‚ñ∂ Play Again";
        status.textContent = "Playback ended";
      };
      
      // Play!
      sourceNode.start(0);
      isPlaying = true;
      playBtn.textContent = "‚èπ Stop";
      status.textContent = "üéµ Playing...\n\nAudioContext state: " + audioContext.state;
      status.textContent += "\nIf no sound, check:\n- Silent mode switch\n- Volume buttons\n- Bluetooth connection";
    });
  </script>
</body>
</html>
